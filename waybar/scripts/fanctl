#!/usr/bin/env bash
  
HWMON_DIR=""
for d in /sys/class/hwmon/hwmon*; do
  if [[ -r "$d/name" ]] && grep -qi '^asus$' "$d/name"; then
    HWMON_DIR="$d"
    break
  fi
done

if [[ -z "$HWMON_DIR" ]]; then
  echo '{"text": "󱑬 N/A", "tooltip": "No fan detected", "class": "fan-unknown"}'
  exit 1
fi

FAN_PATH="$HWMON_DIR/pwm1_enable"
FAN_RPM_PATH="$HWMON_DIR/fan1_input"

get_mode() {
  case "$(cat "$FAN_PATH" 2>/dev/null)" in
    0) echo "manual" ;;
    2) echo "auto" ;;
    *) echo "unknown" ;;
  esac
}

get_rpm() {
  cat "$FAN_RPM_PATH" 2>/dev/null || echo "0"
}

if [[ "$1" == "status" ]]; then
  MODE=$(get_mode)
  RPM=$(get_rpm)

  case "$MODE" in
    manual) CLASS="fan-manual"; ICON="󰈐" ;;
    auto)   CLASS="fan-auto"; ICON="󱜝" ;;
    *)      CLASS="fan-unknown"; ICON="󱑬" ;;
  esac

  [[ "$RPM" =~ ^[0-9]+$ ]] || RPM="0"
  TOOLTIP="Fan Mode: ${MODE}\\nRPM: ${RPM}"

  printf '{"text": "%s %d RPM", "tooltip": "%s", "class": "%s"}\n' \
    "$ICON" "$RPM" "$TOOLTIP" "$CLASS"
  exit 0
fi

MODE=$(get_mode)

if [[ "$MODE" == "auto" ]]; then
  pkexec bash -c "echo 0 > '$FAN_PATH'"
else
  pkexec bash -c "echo 2 > '$FAN_PATH'"
fi
